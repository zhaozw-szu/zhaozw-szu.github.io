<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>基于html+js的关系图谱实验 | 喵</title><meta name="author" content="Zhaozw"><meta name="copyright" content="Zhaozw"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta property="og:type" content="website">
<meta property="og:title" content="基于html+js的关系图谱实验">
<meta property="og:url" content="https://zhaozw-szu.github.io/game/index.html">
<meta property="og:site_name" content="喵">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zhaozw-szu.github.io/img/coverImage/cover3.jpg">
<meta property="article:published_time" content="2024-04-28T13:52:20.000Z">
<meta property="article:modified_time" content="2025-09-11T15:28:20.577Z">
<meta property="article:author" content="Zhaozw">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhaozw-szu.github.io/img/coverImage/cover3.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhaozw-szu.github.io/game/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于html+js的关系图谱实验',
  isPost: false,
  isHome: false,
  isHighlightShrink: false,
  isToc: false,
  postUpdate: '2025-09-11 23:28:20'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" type="text/css" href="/config/css/heoMainColor.css"><link rel="stylesheet" type="text/css" href="/config/css/categoryBar.css"><link rel="stylesheet" type="text/css" href="/config/css/icat.css"><link rel="stylesheet" type="text/css" href="/config/css/emoticon.css"><link rel="stylesheet" href="https://npm.elemecdn.com/swiper@8.4.2/swiper-bundle.min.css" media="print" onload="this.media='all'"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">156</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">25</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-chart-simple"></i><span> 文库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/rank/"><i class="fa-fw fas fa-line-chart"></i><span> 期刊等级</span></a></li><li><a class="site-page child" href="/competition/"><i class="fa-fw fas fa-database"></i><span> 比赛</span></a></li><li><a class="site-page child" href="/code/"><i class="fa-fw fas fa-code"></i><span> 代码</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-sun"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw fas fa-music"></i><span> 日记</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li></ul></div></div></div></div><div class="page" id="body-wrap"><header class="not-home-page" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="喵"><img class="site-icon" src="/img/favicon.png"/><span class="site-name">喵</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-chart-simple"></i><span> 文库</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/rank/"><i class="fa-fw fas fa-line-chart"></i><span> 期刊等级</span></a></li><li><a class="site-page child" href="/competition/"><i class="fa-fw fas fa-database"></i><span> 比赛</span></a></li><li><a class="site-page child" href="/code/"><i class="fa-fw fas fa-code"></i><span> 代码</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-sun"></i><span> 关于</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw fas fa-music"></i><span> 日记</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 小游戏</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="page-site-info"><h1 id="site-title">基于html+js的关系图谱实验</h1></div></header><main class="layout hide-aside" id="content-inner"><div id="page"><div id="knowledge-graph-app"><div class="game-container"><div class="graph-area"><div class="title">交互式知识网络</div><div class="instructions">拖动节点或使用控制面板导航。悬停查看信息。</div><canvas id="gameCanvas"></canvas></div><div class="control-panel"><h3>视图控制</h3><div class="control-group"><label for="zoomSlider">缩放 (Zoom)</label><div class="slider-container"><input id="zoomSlider" type="range" min="0.1" max="3" step="0.05" value="1"><span id="zoomValue">1.00</span></div></div><div class="control-group"><label for="panXSlider">水平平移 (Pan X)</label><div class="slider-container"><input id="panXSlider" type="range" min="-1000" max="1000" step="5" value="0"><span id="panXValue">0</span></div></div><div class="control-group"><label for="panYSlider">垂直平移 (Pan Y)</label><div class="slider-container"><input id="panYSlider" type="range" min="-1000" max="1000" step="5" value="0"><span id="panYValue">0</span></div></div><button id="resetViewBtn">重置视图 (Reset View)</button><div class="node-info-panel hidden"><div class="node-info-title">节点信息</div><div class="node-info-desc">将鼠标悬停在图谱节点上以查看详细信息。</div></div></div></div><script>// --- Constants ---
const CANVAS_BG_COLOR = '#252526';
const NODE_RADIUS = 35;
const NODE_COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#FF9AA2', '#B5EAD7', '#A0D2EB', '#F3EAC2'];
const NODE_DATA = [
  { label: '人工智能', desc: '计算机科学的一个分支，它企图了解智能的实质，并生产出一种新的能以人类智能相似的方式做出反应的智能机器。' },
  { label: '机器学习', desc: '人工智能的一个子集，通过算法使计算机能够从数据中学习并做出决策或预测，而无需明确编程。' },
  { label: '深度学习', desc: '机器学习的一个分支，利用多层神经网络来模拟人脑处理信息的方式，以识别数据中的复杂模式。' },
  { label: '神经网络', desc: '一种模仿生物神经网络结构和功能的计算模型，是深度学习的基础。' },
  { label: '自然语言处理', desc: '计算机科学和人工智能领域，旨在让计算机理解和生成人类语言。' },
  { label: '计算机视觉', desc: '让计算机能够“看”和理解图像或视频内容的技术领域。' },
  { label: '数据科学', desc: '一个跨学科领域，利用科学方法、算法和系统从结构化和非结构化数据中提取知识和见解。' },
  { label: 'Python', desc: '一种广泛使用的高级编程语言，以其简洁易读的语法和强大的库支持而闻名，特别适用于数据科学和AI开发。' },
  { label: '算法', desc: '解决特定问题或执行特定任务的一系列明确定义的计算步骤。' },
  { label: '大数据', desc: '指传统数据处理应用软件不足以处理的大或复杂的数据集，具有体量大、速度快、类型多等特点。' },
  { label: '强化学习', desc: '机器学习的一种范式，智能体通过与环境交互，学习采取何种行动以最大化某种累积奖励。' },
  { label: '生成对抗网络', desc: '一种深度学习模型框架，由生成器和判别器两个神经网络组成，通过相互博弈训练。' }
];
const NODE_POSITIONS = [
  {x: 0, y: -300}, {x: -200, y: -100}, {x: 200, y: -100}, {x: 0, y: 100},
  {x: -300, y: 100}, {x: 300, y: 100}, {x: -200, y: 300}, {x: 200, y: 300},
  {x: 0, y: 500}, {x: -400, y: 300}, {x: 400, y: -100}, {x: 400, y: 100}
];

const PHYSICS = {
  SPRING_CONSTANT: 0.015,
  DAMPING: 0.8,
  REPULSION: 15000,
  ATTRACTION: 0.00002,
  MAX_SPEED: 10
};

const view = { scale: 1, offsetX: 0, offsetY: 0 };

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const nodeInfoPanel = document.querySelector('.node-info-panel');
const nodeInfoTitle = document.querySelector('.node-info-title');
const nodeInfoDesc = document.querySelector('.node-info-desc');

const zoomSlider = document.getElementById('zoomSlider');
const zoomValue = document.getElementById('zoomValue');
const panXSlider = document.getElementById('panXSlider');
const panXValue = document.getElementById('panXValue');
const panYSlider = document.getElementById('panYSlider');
const panYValue = document.getElementById('panYValue');
const resetViewBtn = document.getElementById('resetViewBtn');

class Node {
  constructor(id, x, y, radius, color, label, description) {
    this.id = id;
    this.x = x;
    this.y = y;
    this.originalX = x;
    this.originalY = y;
    this.radius = radius;
    this.color = color;
    this.label = label;
    this.description = description;
    this.dragging = false;
    this.vx = 0;
    this.vy = 0;
  }

  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
    ctx.fillStyle = this.color;
    ctx.fill();
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2 / view.scale;
    ctx.stroke();
    ctx.closePath();

    ctx.font = `bold ${this.radius / 2 / view.scale}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#ffffff';
    ctx.fillText(this.label, this.x, this.y);
  }

  isPointInside(px, py) {
    const invScale = 1 / view.scale;
    const worldX = (px - view.offsetX - canvas.width / 2) * invScale + canvas.width / (2 * view.scale);
    const worldY = (py - view.offsetY - canvas.height / 2) * invScale + canvas.height / (2 * view.scale);
    const distance = Math.sqrt((worldX - this.x) ** 2 + (worldY - this.y) ** 2);
    return distance <= this.radius;
  }
}

class Edge {
  constructor(sourceNodeId, targetNodeId) {
    this.sourceNodeId = sourceNodeId;
    this.targetNodeId = targetNodeId;
  }

  draw(nodes) {
    const sourceNode = nodes.find(n => n.id === this.sourceNodeId);
    const targetNode = nodes.find(n => n.id === this.targetNodeId);
    if (sourceNode && targetNode) {
      ctx.beginPath();
      ctx.moveTo(sourceNode.x, sourceNode.y);
      ctx.lineTo(targetNode.x, targetNode.y);
      ctx.strokeStyle = 'rgba(100, 200, 255, 0.6)';
      ctx.lineWidth = 1.5 / view.scale;
      ctx.stroke();
    }
  }
}

let nodes = [];
let edges = [];

function initGraph() {
  nodes = [];
  edges = [];
  for (let i = 0; i < NODE_DATA.length; i++) {
    nodes.push(new Node(
      i, 
      NODE_POSITIONS[i].x, 
      NODE_POSITIONS[i].y, 
      NODE_RADIUS, 
      NODE_COLORS[i], 
      NODE_DATA[i].label,
      NODE_DATA[i].desc
    ));
  }
  edges.push(
    new Edge(0, 1), new Edge(0, 2), new Edge(1, 3), new Edge(2, 3),
    new Edge(1, 4), new Edge(1, 5), new Edge(1, 6), new Edge(6, 7),
    new Edge(3, 8), new Edge(6, 8), new Edge(6, 9),
    new Edge(2, 4), new Edge(4, 5), new Edge(7, 8), new Edge(3, 9),
    new Edge(2, 10), new Edge(2, 11), new Edge(10, 3), new Edge(11, 3)
  );
}

function applyViewTransform(clear = true) {
  if (clear) {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = CANVAS_BG_COLOR;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  ctx.translate(view.offsetX + canvas.width / 2, view.offsetY + canvas.height / 2);
  ctx.scale(view.scale, view.scale);
  ctx.translate(-canvas.width / (2 * view.scale), -canvas.height / (2 * view.scale));
}

function fitGraphToView(padding = 50) {
  if (nodes.length === 0) return;
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  nodes.forEach(node => {
    minX = Math.min(minX, node.x);
    minY = Math.min(minY, node.y);
    maxX = Math.max(maxX, node.x);
    maxY = Math.max(maxY, node.y);
  });
  const width = maxX - minX;
  const height = maxY - minY;
  if (width === 0 || height === 0) return;
  const scaleX = (canvas.width - 2 * padding) / width;
  const scaleY = (canvas.height - 2 * padding) / height;
  view.scale = Math.min(scaleX, scaleY, 1);
  const centerX = (minX + maxX) / 2;
  const centerY = (minY + maxY) / 2;
  view.offsetX = (canvas.width / 2) - (centerX * view.scale);
  view.offsetY = (canvas.height / 2) - (centerY * view.scale);
  updateSliderValuesFromView();
}

function resetView() {
  fitGraphToView();
}

function updateSliderValuesFromView() {
  zoomSlider.value = view.scale;
  zoomValue.textContent = view.scale.toFixed(2);
  panXSlider.value = view.offsetX;
  panXValue.textContent = view.offsetX.toFixed(0);
  panYSlider.value = view.offsetY;
  panYValue.textContent = view.offsetY.toFixed(0);
}

function updateViewFromSliders() {
  view.scale = parseFloat(zoomSlider.value);
  view.offsetX = parseFloat(panXSlider.value);
  view.offsetY = parseFloat(panYSlider.value);
}

function resizeCanvas() {
  const container = canvas.parentElement;
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight;
  fitGraphToView();
}

resizeCanvas();
window.addEventListener('resize', resizeCanvas);

initGraph();
fitGraphToView();

let animationId;
let draggedNode = null;
let dragOffsetX, dragOffsetY;
let hoveredNode = null;
let isPanning = false;
let lastClientX, lastClientY;

function getMousePos(e) {
  const rect = canvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

canvas.addEventListener('mousedown', (e) => {
  const mousePos = getMousePos(e);
  for (let i = nodes.length - 1; i >= 0; i--) {
    if (nodes[i].isPointInside(mousePos.x, mousePos.y)) {
      draggedNode = nodes[i];
      draggedNode.dragging = true;
      draggedNode.vx = 0;
      draggedNode.vy = 0;
      const invScale = 1 / view.scale;
      const worldX = (mousePos.x - view.offsetX - canvas.width / 2) * invScale + canvas.width / (2 * view.scale);
      const worldY = (mousePos.y - view.offsetY - canvas.height / 2) * invScale + canvas.height / (2 * view.scale);
      dragOffsetX = draggedNode.x - worldX;
      dragOffsetY = draggedNode.y - worldY;
      nodes.splice(i, 1);
      nodes.push(draggedNode);
      nodeInfoPanel.classList.add('hidden');
      nodeInfoTitle.textContent = '节点信息';
      nodeInfoDesc.textContent = '将鼠标悬停在图谱节点上以查看详细信息。';
      return;
    }
  }
  isPanning = true;
  lastClientX = e.clientX;
  lastClientY = e.clientY;
  canvas.style.cursor = 'grabbing';
});

canvas.addEventListener('mousemove', (e) => {
  const mousePos = getMousePos(e);
  if (draggedNode) {
    const invScale = 1 / view.scale;
    const worldX = (mousePos.x - view.offsetX - canvas.width / 2) * invScale + canvas.width / (2 * view.scale);
    const worldY = (mousePos.y - view.offsetY - canvas.height / 2) * invScale + canvas.height / (2 * view.scale);
    draggedNode.x = worldX + dragOffsetX;
    draggedNode.y = worldY + dragOffsetY;
  } else if (isPanning) {
    const dx = e.clientX - lastClientX;
    const dy = e.clientY - lastClientY;
    view.offsetX += dx;
    view.offsetY += dy;
    updateSliderValuesFromView();
    lastClientX = e.clientX;
    lastClientY = e.clientY;
  } else {
    let currentlyHoveredNode = null;
    for (let i = nodes.length - 1; i >= 0; i--) {
      if (nodes[i].isPointInside(mousePos.x, mousePos.y)) {
        currentlyHoveredNode = nodes[i];
        break;
      }
    }
    if (currentlyHoveredNode !== hoveredNode) {
      hoveredNode = currentlyHoveredNode;
      if (hoveredNode) {
        nodeInfoPanel.classList.remove('hidden');
        nodeInfoTitle.textContent = hoveredNode.label;
        nodeInfoDesc.textContent = hoveredNode.description;
      } else {
        nodeInfoPanel.classList.add('hidden');
        nodeInfoTitle.textContent = '节点信息';
        nodeInfoDesc.textContent = '将鼠标悬停在图谱节点上以查看详细信息。';
      }
    }
    canvas.style.cursor = hoveredNode ? 'pointer' : 'default';
  }
});

canvas.addEventListener('mouseup', () => {
  if (draggedNode) {
    draggedNode.dragging = false;
    draggedNode = null;
  }
  if (isPanning) {
    isPanning = false;
    canvas.style.cursor = hoveredNode ? 'pointer' : 'default';
  }
});

canvas.addEventListener('mouseleave', () => {
  if (draggedNode) {
    draggedNode.dragging = false;
    draggedNode = null;
  }
  isPanning = false;
  hoveredNode = null;
  nodeInfoPanel.classList.add('hidden');
  nodeInfoTitle.textContent = '节点信息';
  nodeInfoDesc.textContent = '将鼠标悬停在图谱节点上以查看详细信息。';
  canvas.style.cursor = 'default';
});

canvas.addEventListener('wheel', (e) => {
  e.preventDefault();
  const zoomIntensity = 0.1;
  const wheel = e.deltaY < 0 ? 1 : -1;
  const zoom = Math.exp(wheel * zoomIntensity);
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  const invScale = 1 / view.scale;
  const worldX = (mouseX - view.offsetX - canvas.width / 2) * invScale + canvas.width / (2 * view.scale);
  const worldY = (mouseY - view.offsetY - canvas.height / 2) * invScale + canvas.height / (2 * view.scale);
  view.scale *= zoom;
  view.scale = Math.min(Math.max(0.1, view.scale), 3);
  view.offsetX = mouseX - (worldX - canvas.width / (2 * view.scale)) * view.scale - canvas.width / 2;
  view.offsetY = mouseY - (worldY - canvas.height / (2 * view.scale)) * view.scale - canvas.height / 2;
  updateSliderValuesFromView();
});

zoomSlider.addEventListener('input', () => {
  view.scale = parseFloat(zoomSlider.value);
  zoomValue.textContent = view.scale.toFixed(2);
});

panXSlider.addEventListener('input', () => {
  view.offsetX = parseFloat(panXSlider.value);
  panXValue.textContent = view.offsetX.toFixed(0);
});

panYSlider.addEventListener('input', () => {
  view.offsetY = parseFloat(panYSlider.value);
  panYValue.textContent = view.offsetY.toFixed(0);
});

resetViewBtn.addEventListener('click', resetView);

function animate() {
  animationId = requestAnimationFrame(animate);
  applyViewTransform();
  for (let i = 0; i < nodes.length; i++) {
    const node = nodes[i];
    if (node.dragging) continue;
    let fx = (node.originalX - node.x) * PHYSICS.SPRING_CONSTANT;
    let fy = (node.originalY - node.y) * PHYSICS.SPRING_CONSTANT;
    for (let j = 0; j < nodes.length; j++) {
      if (i !== j) {
        const otherNode = nodes[j];
        const dx = node.x - otherNode.x;
        const dy = node.y - otherNode.y;
        const distanceSq = dx * dx + dy * dy;
        if (distanceSq > 0.01) {
          const distance = Math.sqrt(distanceSq);
          const repulsionForce = PHYSICS.REPULSION / distanceSq;
          fx += (dx / distance) * repulsionForce;
          fy += (dy / distance) * repulsionForce;
        }
      }
    }
    for (const edge of edges) {
      let neighbor = null;
      if (edge.sourceNodeId === node.id) {
        neighbor = nodes.find(n => n.id === edge.targetNodeId);
      } else if (edge.targetNodeId === node.id) {
        neighbor = nodes.find(n => n.id === edge.sourceNodeId);
      }
      if (neighbor && !neighbor.dragging) {
        const dx = neighbor.x - node.x;
        const dy = neighbor.y - node.y;
        fx += dx * PHYSICS.ATTRACTION;
        fy += dy * PHYSICS.ATTRACTION;
      }
    }
    node.vx = (node.vx + fx) * PHYSICS.DAMPING;
    node.vy = (node.vy + fy) * PHYSICS.DAMPING;
    const speed = Math.sqrt(node.vx * node.vx + node.vy * node.vy);
    if (speed > PHYSICS.MAX_SPEED) {
      node.vx = (node.vx / speed) * PHYSICS.MAX_SPEED;
      node.vy = (node.vy / speed) * PHYSICS.MAX_SPEED;
    }
    node.x += node.vx;
    node.y += node.vy;
  }
  edges.forEach(edge => edge.draw(nodes));
  nodes.forEach(node => node.draw());
}

animate();</script></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="comment-tools"><div class="comment-randomInfo"><a onclick="addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow" data-pjax-state="">匿名评论</a></div></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div><script>function addRandomCommentInfo() {
  if (!confirm('开启匿名评论后，任何人将无法回复你的评论（包括博主），是否开启？')) {
    return;
  }
  var inputElements = document.getElementsByClassName('el-input__inner');
  const adjectives = ['幽默的', '豁达的', '温暖的', '优雅的', '活泼的', '迷人的', '甜美的', '聪明的', '坚定的', '善于思考的'];
  const nouns = ['橙子', '茄子', '西瓜', '辣椒', '草莓', '葡萄', '胡萝卜', '柠檬', '苹果', '香蕉'];
  for(var i = 0; i < inputElements.length; i++) {
    var input = inputElements[i];
    var name = input.getAttribute('name');
    const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const randomNoun = nouns[Math.floor(Math.random() * nouns.length)];

    switch (name) {
      case 'nick':
        input.value = `${randomAdj}${randomNoun}`;
        break;
      case 'mail':
        input.value = 'zhaozw-szu@users.noreply.github.com';
        break;
      case 'link':
        input.value = 'https://zhaozw-szu.github.io/';
        break;
      default:
        break;
    }
  }  
}</script></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Zhaozw</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.13.8/mermaid.min.js"></script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script defer src="https://npm.elemecdn.com/swiper@8.4.2/swiper-bundle.min.js"></script><script defer data-pjax src="/js/custom/swiper_init.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'all'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
  //- console.log('MathJax loaded')
} else {
  // 重置 TeX 状态并重新渲染
  MathJax.startup.promise.then(() => {
    MathJax.texReset();  // 重置 TeX 编号等状态
    MathJax.typesetPromise();
  });

  //- MathJax.startup.document.state(0)
  //- MathJax.texReset()
  //- MathJax.typesetPromise()
  //- console.log('MathJax reset')
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://zhaozw.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://zhaozw.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))

    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(init,0)
    else getScript('https://cdn.jsdelivr.net/npm/twikoo@1.6.39/dist/twikoo.all.min.js').then(init)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async defer src="/config/js/categoryBar.js"></script><script type="text/javascript" src="/config/js/about.js"></script><script async src="/config/js/waterfall.js"></script><script defer src="/config/js/essay.js"></script><script defer src="/config/js/emoticon.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>